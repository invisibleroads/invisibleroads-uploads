function enable_upload_button($o) {
  $o.removeAttr('disabled').removeClass('disabled');
}

$('.btn-file input').fileupload({
	dataType: 'json',
	progressall: function(e, d) {
		var progress = parseInt(d.loaded / d.total * 100, 10);
		var $o = $(this).parent('span');
		$o.next('.upload-progress').css('width', progress + '%');
	},
	done: function(e, d) {
    var $o = $(this).parent('span'), upload = d.result;
		$o.next('.upload-progress').css('width', '0%');
    $o.data('upload_id', upload.id).trigger('uploaded.ir.upload', upload);
	}
}).click(function() {
  // Double-clicking should only open a single dialog
  var $o = $(this).parent('span');
  if ($o.prop('disabled')) return false;
  $o.prop('disabled', true).addClass('disabled');
  setTimeout(function() {
    enable_upload_button($o);
  }, 3000);
});

var $o = $('.btn-file');
if (!d.users) {
  // There is no authentication policy
  enable_upload_button($o);
} else if (d.users.user_id) {
  // An authentication policy is defined
  enable_upload_button($o);
} else {
  $o.text($o.text() + ' (Requires Login)');
}

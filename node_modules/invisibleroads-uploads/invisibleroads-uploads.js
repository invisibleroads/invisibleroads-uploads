$.fn.extend({
  'enable': function() {
    var $o = $(this);
    $o.add($o.find('input')).removeAttr('disabled');
  }
});

(function() {

  function get_file_span(x) {
    return $(x).parent('span');
  }

  function set_file_feedback(x, html) {
    get_file_span(x).next('.feedback').html(html);
  }

  $('.btn-file').find('input').fileupload({
    dataType: 'json',
    change: function() {
      get_file_span(this).trigger('upload.ir');
    },
    progressall: function(e, d) {
      set_file_feedback(this, parseInt(d.loaded / d.total * 100) + '%');
    },
    fail: function(e, d) {
      var feedback_html;
      switch(d.jqXHR.status) {
        case 413:
          feedback_html = 'The file was too large to upload directly.';
          break;
        default:
          feedback_html = '';
      }
      set_file_feedback(this, feedback_html);
    },
    done: function(e, d) {
      var x = d.result;
      set_file_feedback(this, '');
      get_file_span(this).data('upload_id', x.upload_id).trigger('uploaded.ir', x);
    }
  });

}());
